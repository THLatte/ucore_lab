#lab3 实验报告 
计22 徐天宇 2012011275

## 练习1 给未被映射的地址映射上物理页

```
需要补充的函数为vmm.c中的do_pgfault。

基本按照注释中给出的说明来实现，首先调用get\_pte函数获取一个pte，根据要求，create参数需指定为1。如果pte没有映射到物理页面，则调用函数pgdir\_alloc\_page来分配一页，完成映射。
```

### 与标准答案的区别

```
因为代码中的注释说明了做法，而且代码量并不大，基本都是调用已有函数，所以和答案差别不大。
```

#### 1. 请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中组成部分对ucore实现页替换算法的潜在用处。

```
当PTE被用来表示一个被置换出去的物理页时，它的最后一位PTE_P为0，即表明此页已经被置换到了硬盘的某个扇区，此时高24位的地址可以用来表示此页在硬盘上的起始扇区的位置（其从第几个扇区开始）。这一设定将更加有利于实现页替换算法。
```

#### 2. 如果ucore的缺页服务例程在执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

```
如果在缺页服务例程中又出现了页访问异常，会引起系统的崩溃，硬件会将现有的数据进行保存，然后执行针对系统崩溃的处理模块。
```

## 练习2 补充完成基于FIFO的页面替换算法

```
需要补充的函数有vmm.c中的do\_pgfault、swap\_fifo.c中的\_fifo\_map\_swappable和\_fifo\_swap\_out\_victim。

do\_pgfault函数中，实现原理和注释中的说明基本一致，首先调用函数swap\_in将外存中的相应页加载进来，然后建立物理地址和虚拟地址的映射，最后调用swap\_map\_swappable函数将该页插入到访问列表的最前端。

\_fifo\_map\_swappable函数实现的是将对应的页插入到访问列表的最前端（head之后），代表这一页是最近刚刚进入内存的。此函数为实现fifo的页查找提供了帮助。需要补充的内容即将传进来的page插入到pra\_list\_head之后，代表这一页是最近刚刚调入内存的。

\_fifo\_swap\_out\_victim函数实现将最早进入内存的页换出去。实现基本同注释，根据pra\_list的设定，它的最末尾的元素，即head的前一个元素代表最早进入内存的页，所以将这一页从链表中删除，并将传入的参数ptr_page设定为指向该页。
```

### 与标准答案的区别

```
因为是按照注释的说明做的，所以和标准答案的差别并不是很大，只是少了一些判断条件，比如swap\_in失败、pra\_list仅包含head一项等。
```

#### 如果要在ucore上实现"extended  clock页替换算法"请给你的设计方案，现有的swap_manager框架是否足以支持在ucore中实现此算法？如果是，请给你的设计方案。如果不是，请给出你的新的扩展和基此扩展的设计方案。并需要回答如下问题
  需要被换出的页的特征是什么？
  在ucore中如何判断具有这样特征的页？
  何时进行换入和换出操作？

```
无法支持，需要增加一个指向页面的指针，并需要对pte在表示被置换出去的物理页时的结构进行修改。pte增加一个修改位和一个访问位，当页面被访问的时候将访问位置1，被写的时候将修改位置1。当需要淘汰页的时候，对指针所指向的页进行查询，根据访问位和修改位的不同决定淘汰的优先度，均为0的优先淘汰，（0,1）其次选择，（1,0）再次，（1,1）最后淘汰。

需要被换出的页的特征是最近没有被修改也没有被访问。

根据前面所述设置的访问位和修改位进行判断，均为0则为需要被换出的页。

当发生缺页异常的时候进行换入，换出则有两种模式：一种是积极换出策略，操作系统周期性地或系统不忙的时候主动把某些符合特定条件的页换出到硬盘上；另一种是消极换出策略，只有当试图得到空闲页但当前没有空闲页可供分配的时候才进行换出。
```

## 列出你认为本实验中重要的知识点， 以及与对应的OS原理中的知识点， 并简要说明你对二者的含义， 关系，差异等方面的理解

```
本实验比较重要的知识点有：
1. 虚拟内存。为了给进程提供更大的运行空间，使用虚拟内存的手法使得实际的物理内存得到了更加充分有效的利用，就像是一块更大的虚拟的空间一样。其中逻辑地址和物理地址的对应通过页机制完成映射和管理。
2. 缺页异常。当一条指令或数据的虚拟地址所对应的物理页帧不在内存中或者访问的类型出现错误时，就会发生缺页异常。这时会调用缺页服务例程进行相应的处理，或建立虚拟地址和实际地址的对应关系，或进行页的换入换出操作，将不常访问的页换出，将所需要的页换入。如果在缺页服务例程中再次出现缺页异常，则会导致系统的崩溃。
3. 页置换算法中的局部置换算法。实验中涉及到的是fifo和extended clock页置换算法，它们都实现将某一页换出，为所需要的页腾出空间，但不同之处在于对该淘汰哪一页的选择不同，fifo并不考虑局部性原理，而extended clock则考虑了局部性原理。后者更加接近于LRU算法。
```

## 列出你认为OS原理中很重要， 但在实验中没有对应上的知识点

```
全局置换算法、虚拟地址到物理地址的转换实现
```